import axios, { AxiosError } from 'axios';

//??????????????????????????????????????????????????????????????????????????????
//? INICIALIZAÇÕES
//??????????????????????????????????????????????????????????????????????????????
const baseUrl = process.env.NEXT_PUBLIC_API;
const core = axios.create({
  baseURL: baseUrl,
  headers: {
    'Content-Type': 'application/json',
  },
  withCredentials: true, // Permite o envio de cookies com as requisições
});

//??????????????????????????????????????????????????????????????????????????????
//? metodo para deslogar o usuário em caso de receber erro 401 e não conseguir
//? alicar refresh token, setAuthFailHandler é usado por authContext para
//? permitir que api o chame para deslogar o usuário (usado em canTryAgain)
//??????????????????????????????????????????????????????????????????????????????
let onAuthFail: (() => void) | null = null;
export function setAuthFailHandler(handler: () => void) {
  onAuthFail = handler;
}

//??????????????????????????????????????????????????????????????????????????????
//? TIPAGEM
//??????????????????????????????????????????????????????????????????????????????
type apiProps = {
  method: 'get' | 'post' | 'put' | 'delete' | 'patch';
  url: string;
  data?: any;
  params?: any;
}

//??????????????????????????????????????????????????????????????????????????????
//? FUNÇÕES PUBLICA
//??????????????????????????????????????????????????????????????????????????????
const api = async (config: apiProps) => {
  const isFormData = config.data instanceof FormData;

  try {
    const response = await core.request({
      method: config.method,
      url: config.url,
      data: config.data,
      params: config.params,
      headers: config.data instanceof FormData ? { "Content-Type": "multipart/form-data" } : undefined, //com 'undefined' não é substituido o padrão definido no core
    });
    return response.data;
  } catch (error) {
    if (error instanceof AxiosError && await canTryAgain(error)) {
      try {
        const response = await core.request({
          method: config.method,
          url: config.url,
          data: config.data,
          params: config.params,
        });
        return response.data;
      } catch (error) {
        handleException(error);
      }
    }
    handleException(error);
  }
}
export default api;

//??????????????????????????????????????????????????????????????????????????????
//? FUNÇÕES PRIVADAS
//??????????????????????????????????????????????????????????????????????????????
async function canTryAgain(error: AxiosError) {
  if (!error.response) return false; // Se não houver resposta, não é possível tentar novamente
  const statusCode = error.response.status;
  if (statusCode !== 401)
    return false;

  try {
    await core.request({
      method: 'post',
      url: '/auth/refresh',
    });
    return true;
  } catch (error) {
    if (onAuthFail) //usuário será deslogado na marra
      onAuthFail();
    return false;
  }
}

function handleException(error: any) {
  let errorMessage = error instanceof Error ? error.message : 'Ocorreu um erro desconhecido';

  if (error instanceof AxiosError)
    errorMessage = error.response?.data?.message || errorMessage;

  throw new Error(errorMessage);
}

//??????????????????????????????????????????????????????????????????????????????
//? FUNÇÕES AUXILIARES PARA MANIPULAÇÃO DO HEADER
//? Usado para informar o Backend se é para mandar cookie com expiração ou não
//??????????????????????????????????????????????????????????????????????????????
export function setRememberMe(rememberMe: boolean) {
  rememberMe = rememberMe || localStorage.getItem('rememberMe') === 'true';
  if (!rememberMe) {
    delete core.defaults.headers.common['remember-me']; // Remove o token se não for fornecido
  } else {
    core.defaults.headers.common['remember-me'] = rememberMe; // Define o token no cabeçalho Authorization
    localStorage.setItem('rememberMe', rememberMe.toString());
  }
}

export function forgetMe() {
  delete core.defaults.headers.common['remember-me'];
  localStorage.removeItem('rememberMe');
}